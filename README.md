# XUNX AdLink (PHP 7+)

## Архитектура проекта

- `public/ad.js` — клиентский скрипт паблишера. Сканирует текст страницы, отправляет ключевые слова на сервер и вставляет рекламные слова в контент.
- `api/ads.php` — API подбора рекламы. Принимает ключевые слова и отдаёт до 3 объявлений по убыванию CPC с учётом гео, лимитов и баланса.
- `api/impression.php` — фиксация показов для статистики.
- `api/click.php` — трекер кликов. Сразу пишет клик в БД, запускает антифрод и финансовую логику.
- `lib/` — минимальные функции для БД, гео и антифрода.
- `database/schema.sql` — структура таблиц.
- `config.php` — настройки БД, список регионов РФ и лимит антифрода.

## Структура БД

Схема в `database/schema.sql` включает:

- `advertisers` — рекламодатели и их баланс.
- `campaigns` — кампании, ставка CPC, формат, лимиты и бюджеты.
- `keywords` — ключевые слова по кампаниям.
- `publishers` — площадки, домены, баланс и статус модерации.
- `impressions` — показы.
- `clicks` — клики с флагом `is_fraud`, причиной и признаком зачёта.
- `transactions` — финансовые операции.

## PHP-логика подбора рекламы

`api/ads.php` принимает массив ключевых слов и `publisher_id`.

1. Проверяет паблишера и регион РФ.
2. Нормализует ключевые слова.
3. Берёт до 3 объявлений с максимальным CPC.
4. Возвращает JSON `ads` с типом рекламы и креативами.

## JS-логика вставки рекламы

`public/ad.js`:

1. Собирает слова из текста страницы.
2. Запрашивает объявления у `api/ads.php`.
3. Вставляет максимум 3 рекламных слова:
   - `span` с жирным подчёркиванием.
   - тулбар появляется при клике/наведении.
   - переход только из тулбара.
   - одно упоминание на рекламодателя.

## Трекер кликов

`api/impression.php`:

- Принимает `publisher_id`, `campaign_id`, `keyword_id`, `page_url`.
- Записывает показ для статистики.

`api/click.php`:

- Принимает `publisher_id`, `campaign_id`, `keyword_id`, `page_url`, `fingerprint`, `time_on_page_ms`.
- Проверяет регион и антифрод.
- Записывает клик сразу.
- Делает списание рекламодателя и начисление паблишеру при валидном клике.
- Возвращает `allowed: true|false`.

## Антифрод логика

Без CAPTCHA, простые правила:

- нет IP или User-Agent → фрод;
- не совпадает реферер с доменом паблишера → фрод;
- превышен лимит кликов с одного IP на кампанию за 10 минут → фрод.
- слишком быстрый клик → фрод.
- превышен лимит кликов по fingerprint → фрод.

Лимит настраивается в `config.php`.

## Вставка JS на сайт паблишера

```html
<script
  src="https://your-domain.com/public/ad.js"
  data-endpoint="https://your-domain.com/api/ads.php"
  data-click-endpoint="https://your-domain.com/api/click.php"
  data-impression-endpoint="https://your-domain.com/api/impression.php"
  data-publisher-id="1"
></script>
```
